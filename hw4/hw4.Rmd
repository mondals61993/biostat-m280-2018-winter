---
title: "hw4"
output: html_document
---

```{r warning = FALSE, eval = FALSE}
library(sparklyr)
library(ggplot2)
library(dplyr)
library(mapdata)
library(ggrepel)
```

```{r}
Sys.setenv(SPARK_HOME="/usr/lib/spark")
config <- spark_config()
sc <- spark_connect(master = "yarn-client", config = config)
sc
```

```{r}
flights_tbl <- tbl(sc, 'flights')
airlines_tbl <- tbl(sc, 'airlines')
airports_tbl <- tbl(sc, 'airports')

```

##1. Map the top 10 busiest airports. Size of dots should reflect the number of flights through that destination.

```{r}
usa <- map_data('usa')

```


```{r}
busiest10 <- flights_tbl %>% select(origin, dest) %>% 
  group_by(origin) %>% summarize(cnt = count()) %>% 
  arrange(desc(cnt)) %>%
  collect()
```

```{r}
busiest10_dest <- flights_tbl %>% select(origin, dest) %>%
  group_by(dest) %>% summarize(cnt2 = count()) %>%
  arrange(desc(cnt2)) %>%
  collect()

```

```{r}
busiest10 <- busiest10 %>% head(10) %>% 
  rename(airport = origin)

busiest10_dest <- busiest10_dest %>% head(10) %>%
  rename(airport = dest)

busiest10 <- busiest10 %>% 
  inner_join(busiest10_dest, by = 'airport') %>%                              mutate(sum = rowSums(.[2:3])) %>%
  arrange(desc(sum))
```

```{r}
busiest_coord <- airports_tbl %>%
  select(faa, lat, lon) %>%
  filter(faa %in% busiest10$airport) %>% 
  mutate(lat = as.numeric(as.character(lat)),
         lon = as.numeric(as.character(lon))) %>%
  collect()
```

```{r}
usa <- map_data("usa")
base_map <- ggplot() + geom_polygon(data = usa, 
                                      aes(x = long, y = lat, group = group)) + 
                      coord_fixed(1.3)
base_map + geom_point (data = busiest_coord, 
                       aes(x = lon, y = lat), 
                       color = 'yellow', 
                       size = 4)
```

##2. Map the top 10 busiest direct routes. Size of lines should reflect the number of flights through that route.

```{r}
all <- flights_tbl %>%
  select(year, month, dayofmonth,
         origin, dest) %>%
  filter(year >= 1998) %>%
  filter(origin == 'LAX'|dest == 'LAX') %>%
  collect()
```

```{r}
flight_data <- flights_tbl %>% 
  select(year, month, dayofmonth,
         origin, dest) %>%
  filter(year == 1987) %>%
  collect()
```

```{r}
airports <- airports_tbl %>%
  select(faa, lat, lon) %>%
  collect()
```

```{r}
busiest_route <- flight_data %>% select(year, origin, dest) %>%
  filter(year == 1987) %>%
  group_by(origin, dest) %>%
  summarize(n = count()) %>%
  collect()

```

```{r}
busiest_route <- busiest_route %>%
  arrange(desc(n)) %>%
  head(10) %>% ungroup() %>%
  mutate(rank = seq(1:10)) 

origin_coords <- airports_tbl %>% 
  select(lat, lon, faa) %>% 
  filter(faa %in% busiest_route$origin) %>%
  rename(origin = faa) %>%
  collect() 

dest_coords <- airports_tbl %>%
  select(lat, lon, faa) %>% 
  filter(faa %in% busiest_route$dest) %>%
  rename(dest = faa, lat_dest = lat, lon_dest = lon) %>%
  collect()

busiest_route2 <- inner_join(busiest_route, origin_coords, by = 'origin')
busiest_route2 <- inner_join(busiest_route2, dest_coords, by = 'dest')
busiest_route2 <- busiest_route2 %>%
  mutate(lat = as.numeric(lat),
         lon = as.numeric(lon),
         lat_dest = as.numeric(lat_dest),
         lon_dest = as.numeric(lon_dest))

```

```{r}
airports<-sort(unique(c(busiest_route2$origin,
                        busiest_route2$dest)))

lat_lon <- airports_tbl %>% select(faa, lat, lon) %>%
  filter(faa %in% airports) %>% 
  collect() %>% arrange(faa)

airports <- data.frame(airport = airports, lat_lon[,2:3])
airports <- airports %>% mutate(lat = as.numeric(lat), 
                                lon = as.numeric(lon))

```

```{r}
usamap <- borders("usa")

ggplot() + usamap + geom_curve(data = busiest_route2, 
             aes(x = lon, y = lat, 
                 xend = lon_dest, yend = lat_dest),
             col = "#b29e7d") + 
          geom_point(data = airports,
                     aes(x = lon, y = lat)) + 
          geom_text_repel(data=airports, 
                  aes(x = lon, y = lat, label = airport), 
                  col = "black", size = 2, 
                  segment.color = NA)
```

##3. 
###a. Reproduce above plot. Visualize and explain some prominent features you observe. For example, what happened at points 1-5?

```{r}
air_traf <- flights_tbl %>%
  select(year, month, dayofmonth, origin, dest) %>%
  filter(year >= 1998) %>%
  filter(origin == 'LAX'|dest == 'LAX') %>%
  group_by(year, month, dayofmonth) %>%
  summarize(cnt= count()) %>%
  collect()

air_traf
```

```{r}
air_traf <- air_traf %>%
  ungroup() %>%
  mutate(fin_date = as.Date(with(air_traf, paste(year, month, 
                                         dayofmonth, 
                                         sep = '-')),
         '%Y-%m-%d'))
```

```{r}
ggplot(data = air_traf) + 
  geom_line(mapping = aes(x = fin_date, y = cnt)) + 
  labs(x = 'date',
      y = 'n', 
      title = 'LAX air traffic'
  )
  
```

###b. Visualize and explain seasonal effects.
```{r}

air_traf <- air_traf %>% ungroup() %>%
  mutate(season = ifelse(month >= 1 & month <=3, 'Winter',
                        ifelse(month >= 4 & month <6, 'Spring',
                          ifelse(month >= 6 & month <= 8, 'Summer', 
                                ifelse(month >= 9 & month <=12, 'Fall',
                                'F')))))

ggplot(data = air_traf) + 
  geom_freqpoly(mapping = aes(x = cnt, color = season)) + 
  labs(x = 'Flight Count')


```

```{r}
ggplot(data = air_traf) + 
  geom_boxplot(mapping = aes(x = season, y = cnt))

```

I added a 'season' variable that was broken up into Fall, Spring, Summer, and Winter. 

###c. Visualize and explain weekly effects.
```{r}
air_traf <- air_traf %>%
  mutate(wknum = strftime(fin_date, format = '%V'))

ggplot(data = air_traf) + 
  geom_boxplot(mapping=aes(x = wknum, y = cnt)) + 
  labs(x = 'Week Number', 
       y = 'n', 
       title = 'Air Traffic by Week of the Year') + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

###d. Map top 10 destinations from LAX. Size of dots should reflect the number of flights from LAX to that destination. 

```{r}
top10_lax <- all %>% 
  select(year, month, dayofmonth, origin, dest) %>%
  filter(origin == 'LAX') %>%
  filter(year >= 1998) %>%
  group_by(dest) %>%
  summarize(cnt = n()) %>%
  collect()
```

```{r}
top10_lax <- top10_lax %>% arrange(desc(cnt))
```

```{r}
flight_coords <- airports %>%
  select(faa, lat, lon) %>%
  filter(faa %in% top10$dest) %>%
  rename(dest = faa) %>%
  collect()

la_coords <- airports %>%
  select(faa, lat, lon) %>%
  filter(faa == 'LAX') %>%
  rename(origin = faa,
         la_lat = lat,
         la_lon = lon) 

top10_lax <- inner_join(top10_lax, flight_coords, by = 'dest')
top10_lax$origin <- rep('LAX', 104)
top10_lax <- inner_join(top10_lax, la_coords, by = 'origin')

```

```{r}
top10_lax <- top10_lax %>%
  mutate(lat = as.numeric(lat), 
         lon = as.numeric(lon),
         la_lat = as.numeric(la_lat),
         la_lon = as.numeric(la_lon))

top10_lax <- top10_lax %>%
  arrange(desc(cnt)) %>%
  head(10) %>% ungroup() %>%
  mutate(rank = seq(1:10))
```

```{r}
airports_2<-sort(unique(c(top10_lax$origin,
                        top10_lax$dest)))

lat_lon <- airports %>% select(faa, lat, lon) %>%
  filter(faa %in% airports_2) %>% 
  collect() %>% arrange(faa)

airports_2 <- data.frame(airport = airports_2, lat_lon[,2:3])
airports_2 <- airports_2 %>% mutate(lat = as.numeric(lat), 
                                lon = as.numeric(lon))
```

```{r}
top10_lax <- top10_lax %>% 
  rename(airport = dest) %>%
  arrange(airport)
```

```{r}
airports_2 <- airports_2 %>% filter(airport != 'LAX') %>%
  arrange(airport) %>%
  mutate(rank = top10_lax$rank)
```


```{r warning = FALSE, message = FALSE}
usamap2 <- borders("usa")

ggplot() + usamap2 + geom_curve(data = top10_lax, 
             aes(x = la_lon, y = la_lat, 
                 xend = lon, yend = lat),
             col = "#b29e7d") + 
          geom_point(data = airports_2,
                     aes(x = lon, y = lat, size = factor(rank))) + 
          geom_text_repel(data=airports_2, 
                  aes(x = lon, y = lat, label = airport), 
                  col = "black", size = 2, 
                  segment.color = NA) 
         

 
```

